{% extends "base.html" %}

{% block head %}
<title>ChattingTheBot</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" />
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='jquery.mCustomScrollbar.min.css') }}" />
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='chatBotStyle1.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='chatBotStyle.css') }}">
{% endblock %}

{% block main %}
<div id="chatBox" style="display: block;">
    <section id="avenue-messenger" class="avenue-messenger">
        <div class="menu"></div>
        <div class="agent-face">
            <img class="agent circle" src="https://cliply.co/wp-content/uploads/2019/05/371905140_MEET_ROBOT_400px.gif" alt="Chatbot" style="margin-top: 70px;">
        </div>
        <div class="chat">
            <div class="chat-title">
                <h1>ChattingTheBot</h1>
                <h2>AI Chatbot</h2>
            </div>
            <div class="messages">
                <div class="messages-content"></div>
            </div>
            <div class="message-box">
                <textarea type="text" class="message-input" placeholder="Type message..."></textarea>
                <button type="submit" class="message-submit">Send</button>
            </div>
        </div>
    </section>
</div>
<script src="{{ url_for('static', filename='chatbotsection/jquery-3.5.1.min.js') }}"></script>
<script src="{{ url_for('static', filename='chatbotsection/jquery.mCustomScrollbar.concat.min.js') }}"></script>
<script src="{{ url_for('static', filename='chatbotsection/script.js') }}"></script>


<script>
    var $messages = $('.messages-content'),
        d, h, m,
        i = 0;

    $(window).load(function() {
        $messages.mCustomScrollbar();
        setTimeout(function() {
            fakeMessage();
        }, 500);
    });

    function updateScrollbar() {
        $messages.mCustomScrollbar("update").mCustomScrollbar('scrollTo', 'bottom', {
            scrollInertia: 10,
            timeout: 0
        });
    }

    function setDate() {
        d = new Date();
        if (m != d.getMinutes()) {
            m = d.getMinutes();
            $('<div class="timestamp">' + d.getHours() + ':' + m + '</div>').appendTo($('.message:last'));
            $('<div class="checkmark-sent-delivered">&check;</div>').appendTo($('.message:last'));
            $('<div class="checkmark-read">&check;</div>').appendTo($('.message:last'));
        }
    }

    function insertMessage() {
        var msg = $('.message-input').val();
        if ($.trim(msg) == '') {
            return false;
        }
        $('<div class="message message-personal">' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
        setDate();
        $('.message-input').val(null);
        updateScrollbar();
        setTimeout(function() {
            fakeMessage(msg);
        }, 500 + (Math.random() * 20) * 100);
    }

    $('.message-submit').click(function() {
        insertMessage();
    });

    $(window).on('keydown', function(e) {
        if (e.which == 13) {
            insertMessage();
            return false;
        }
    });

    function fakeMessage(msg) {
        if ($('.message-input').val() != '') {
            return false;
        }
        $('<div class="message loading new"><figure class="avatar"><img src="{{ url_for('static', filename='chatbot_icon.png') }}" /></figure><span></span></div>').appendTo($('.mCSB_container'));
        updateScrollbar();

        setTimeout(function() {
            $.ajax({
                type: "POST",
                url: "/ask?message=" + msg + "&sessionId={{ sessionId }}",
                data: $(this).serialize(),
                success: function(response) {
                    $('.message.loading').remove();
                    for (var i = 0; i <= response.answer.length - 1; i++) {
                        $('<div class="message new"><figure class="avatar"><img src="{{ url_for('static', filename='chatbot_icon.png') }}" /></figure>' + response.answer[i] + '</div>').appendTo($('.mCSB_container')).addClass('new');
                    }
                    setDate();
                    updateScrollbar();
                    i++;
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }, 10 + (Math.random() * 20) * 100);
    }
</script>
{% endblock %}
